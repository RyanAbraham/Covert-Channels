<html>
  <head>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    <script>
      config = {};
      function sendOpen() {
        console.log("open");
        var cmd = JSON.stringify({
          OpCode : "open",
          Processors   : config.Processors,
          Channel      : {
            Type : config.Channel.Type,
            Data : config.Channel.Data
          }
        });
        console.log(cmd);
        sock.send(cmd,{binary:true});
      }
      function sendClose() {
        console.log("close");
        var cmd = JSON.stringify({OpCode : "close"});
        sock.send(cmd,{binary:true});
      }
      function sendWrite() {
        console.log("write");
        var msg = $("#message").val()
        var cmd = JSON.stringify({OpCode : "write", Message : msg});
        sock.send(cmd,{binary:true});
      }
      function sendConfig() {
        console.log("config");
        var cmd = JSON.stringify({OpCode : "config"});
        sock.send(cmd,{binary:true});
      }

      function writeResponse(response) {
        $('#response').val(function(i, text) {
            return text + response + "\n";
        });
      }

      function handleConfig(data) {
        config = data;
        $("#channel").empty();
        $("#channel").append(createConfigDiv(data.Channel));
        createProcessors(data.Processors);
      }

      function deepCopy(o) {
        return JSON.parse(JSON.stringify(o));
      }

      function addProcessor() {
        var data = deepCopy(config.Default.Processor);
        var type = Object.keys(data)[0];
        config.Processors.push({ Type : type, Data : data });
        createProcessors(config.Processors);
      }

      function createProcessors(processors){
        $("#processors").empty();
        processors.forEach(function (c, index) {
          $("#processors").append(createProcessorSpan(c, index, processors));
        });
      }

      function createProcessorSpan(configData, index, processors){
        var parent = $("<div>").css({ 'border-color' : 'black', 'border-style' : 'solid', padding : "10px", margin : "10px" });
        var remove = $("<button>-</button>");
        remove.on("click", function(index, processors){
          processors.splice(index, 1);
          createProcessors(processors);
        }.bind(null, index, processors));
        var conf = createConfigDiv(configData);
        return parent.append(remove).append(conf);
      }

      function createConfigDiv(configData) {
        var parent = $("<div>");
        var sel    = $("<select>");
        var confDiv = $("<div>");
        parent.append(sel).append(confDiv);

        sel.on("change", selectConfig.bind(sel, configData, confDiv));
        for (key in configData.Data) {
          if (configData.Data.hasOwnProperty(key)) {
            sel.append($("<option>").attr('value', key).html(key));
          }
        }
        sel.val(configData.Type).change();
        return parent;
      }

      function selectConfig(configData, parent) {
        console.log(event);
        configData.Type = this.val();
        var tbl = handleConfigKeys(configData.Data[this.val()])
        parent.empty().append(tbl);
      }

      function handleConfigKeys(data) {
        var tbl = $("<table>");
        for (var key in data) {
          if (data.hasOwnProperty(key)) {
            var tr = $("<tr></tr>")
            tr.appendTo(tbl);
            var td = $("<td></td>").html(key);
            td.appendTo(tr);
            td = $("<td></td>");
            var val = data[key].Value;
            var input;
            switch (data[key].Type) {
              case "i8":
                input = $("<input>").attr("type","number").attr({ min : data[key].Range[0], max : data[key].Range[1]}).val(val);
                break;
              case "u16":
                input = $("<input>").attr("type","number").attr({ min : data[key].Range[0], max : data[key].Range[1]}).val(val);
                break;
              case "u64":
                input = $("<input>").attr("type","number").attr({ min : data[key].Range[0], max : data[key].Range[1]}).val(val);
                break;
              case "bool":
                input = $("<input>").attr("type","checkbox").prop('checked', val).val(val);
                break;
              case "select":
                input = $("<select>");
                for (o in data[key].Range) {
                  input.append('<option value="'+ data[key].Range[o] +'">' + data[key].Range[o] + '</option>')
                }
                input.val(data[key].Value);
                break;
              case "ipv4":
                  input = $("<input>").attr("type","text").val(val);
                  break;
            }
            input.on('input', function (obj) {
              if (obj.Type === "bool") {
                obj.Value = this.prop('checked');
              } else if (obj.Type == "u16" || obj.Type == "u64" || obj.Type == "i8") {
                obj.Value = Number(this.val());
              } else {
                obj.Value = this.val();
              }
              console.log(obj.Value);
            }.bind(input, data[key]));
            td.append(input);
            td.appendTo(tr);

            var desc = $('<div>').attr('title', data[key].Display.Description).css('width','10px').css('height','10px').css({'background-color' : 'red'});
            td = $('<td>').append(desc);
            td.appendTo(tr);
          }
        }
        return tbl;
      }

      $(document).ready(function() {

        var address = prompt ('Please enter the address to connect to. [Example Below]', 'localhost:3000');
				sock = new WebSocket('ws://' + address + '/api/ws');

        sock.binaryType = 'arraybuffer';
				sock.onopen = function (event) {
					writeResponse('Auto Connection established');
          sendConfig()
				};

				sock.onerror = function (event) {
					writeResponse('Auto Connection error');
				};

        sock.onmessage = function (event) {
          console.log("received message");
          console.log(event.data);
					if(event.data) {
            var data = JSON.parse(event.data);
            if (data.OpCode === "config"){
              handleConfig(data);
            } else {
              writeResponse(event.data);
            }
          }
				};
      });
    </script>
  </head>
  <body>
    <div>
      <input type="button" onclick="sendOpen()">Open</input>
      <input type="button" onclick="sendClose()">Close</input>
      <input type="button" onclick="sendWrite()">Write</input>
      <input type="button" onclick="sendConfig()">Config</input>
    </div>
    <div><input type="text" id="message"></input></div>
    <div><h2>Console</h2><textarea id="response" cols="100" rows="10"></textarea></div>
    <h1>Processor</h1>
    <div><button type="button" onclick="addProcessor()">+</button></div>
    <div id="processors"></div>
    <h1>Channel</h1>
    <span id="channel"></span>
  </body>
</html>
